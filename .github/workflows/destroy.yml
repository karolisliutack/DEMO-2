name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - staging
          - prod
      confirmation:
        description: 'Type the environment name to confirm destruction'
        required: true
        type: string

# Prevent concurrent destroy operations
concurrency:
  group: destroy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  validate-confirmation:
    name: Validate Destruction Confirmation
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Verify confirmation matches environment
        run: |
          if [[ "${{ github.event.inputs.confirmation }}" != "${{ github.event.inputs.environment }}" ]]; then
            echo "::error::Confirmation does not match environment name"
            echo "Expected: ${{ github.event.inputs.environment }}"
            echo "Received: ${{ github.event.inputs.confirmation }}"
            exit 1
          fi
          echo "Confirmation verified for environment: ${{ github.event.inputs.environment }}"

      - name: Log destruction attempt
        run: |
          echo "### Infrastructure Destruction Request" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Requested by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

  destroy-staging:
    name: Destroy Staging Infrastructure
    runs-on: ubuntu-latest
    needs: validate-confirmation
    if: github.event.inputs.environment == 'staging'

    environment:
      name: staging

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3.1.2
        with:
          terraform_version: ~1.9.0
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502  # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=staging/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="encrypt=true"

      - name: Create dummy Lambda zip (required for Terraform validation)
        run: |
          echo "placeholder" > /tmp/dummy.py
          cd /tmp && zip dummy.zip dummy.py

      - name: Terraform Destroy
        working-directory: terraform
        env:
          TF_VAR_lambda_zip_path: /tmp/dummy.zip
        run: |
          terraform destroy \
            -var-file="staging.tfvars" \
            -auto-approve \
            -input=false

      - name: Verify destruction
        working-directory: terraform
        run: |
          echo "### Staging Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Destroyed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completed at**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **State file**: staging/terraform.tfstate (preserved in S3)" >> $GITHUB_STEP_SUMMARY

  destroy-prod:
    name: Destroy Production Infrastructure
    runs-on: ubuntu-latest
    needs: validate-confirmation
    if: github.event.inputs.environment == 'prod'

    # Production destruction requires manual approval via environment protection
    environment:
      name: production

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3.1.2
        with:
          terraform_version: ~1.9.0
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502  # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="encrypt=true"

      - name: Create dummy Lambda zip (required for Terraform validation)
        run: |
          echo "placeholder" > /tmp/dummy.py
          cd /tmp && zip dummy.zip dummy.py

      - name: Terraform Destroy
        working-directory: terraform
        env:
          TF_VAR_lambda_zip_path: /tmp/dummy.zip
        run: |
          terraform destroy \
            -var-file="prod.tfvars" \
            -auto-approve \
            -input=false

      - name: Verify destruction
        working-directory: terraform
        run: |
          echo "### Production Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: production" >> $GITHUB_STEP_SUMMARY
          echo "- **Destroyed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completed at**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **State file**: prod/terraform.tfstate (preserved in S3)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "::notice::Production infrastructure has been completely destroyed"
