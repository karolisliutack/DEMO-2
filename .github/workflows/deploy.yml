name: Deploy Serverless Health Check API

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - prod

# Prevent concurrent deployments to the same environment
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

# Restrict default permissions and grant only what's needed per job
permissions:
  contents: read
  id-token: write  # Required for OIDC if you migrate from static credentials

jobs:
  security-scan:
    name: Security & Compliance Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # For uploading SARIF results if needed

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1

      # Infrastructure as Code Security Scanning
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@b466648d6e39e7c75324f25d83891162a721f2d6  # v1.0.3
        with:
          working_directory: terraform
          soft_fail: false
          format: default

      - name: Run Checkov IaC scanner
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform
          framework: terraform
          config_file: terraform/.checkov.yml
          output_format: cli
          quiet: false

      # Python Security Scanning
      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: lambda/requirements.txt

      - name: Install dependencies for scanning
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit bandit safety
          # Install project dependencies for audit
          pip install -r lambda/requirements.txt --target /tmp/lambda-deps

      - name: Run pip-audit (dependency vulnerability scan)
        run: |
          pip-audit --requirement lambda/requirements.txt --desc

      - name: Run Bandit (Python SAST)
        run: |
          bandit -r lambda/ -f json -o bandit-report.json || true
          bandit -r lambda/ -f screen

      - name: Upload Bandit results
        uses: actions/upload-artifact@84480863f228bb9747b473957fcc9e309aa96097  # v4.4.2
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json
          retention-days: 30

  package-lambda:
    name: Package Lambda Function
    runs-on: ubuntu-latest
    needs: security-scan
    permissions:
      contents: read

    outputs:
      lambda-artifact-name: ${{ steps.package.outputs.artifact-name }}
      lambda-version: ${{ steps.package.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1

      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: lambda/requirements.txt

      - name: Package Lambda function
        id: package
        run: |
          # Create build directory
          mkdir -p build/lambda

          # Install dependencies
          pip install -r lambda/requirements.txt --target build/lambda --upgrade

          # Copy source code
          cp lambda/*.py build/lambda/

          # Create versioned zip artifact
          VERSION="${GITHUB_SHA::8}"
          ARTIFACT_NAME="lambda-${VERSION}.zip"

          cd build/lambda
          zip -r "../../${ARTIFACT_NAME}" . -x "*.pyc" -x "__pycache__/*"
          cd ../..

          # Verify zip contents
          echo "Lambda package contents:"
          unzip -l "${ARTIFACT_NAME}"

          # Set outputs
          echo "artifact-name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Display package size
          ls -lh "${ARTIFACT_NAME}"

      - name: Upload Lambda artifact
        uses: actions/upload-artifact@84480863f228bb9747b473957fcc9e309aa96097  # v4.4.2
        with:
          name: lambda-package-${{ steps.package.outputs.version }}
          path: lambda-*.zip
          retention-days: 90
          if-no-files-found: error

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [security-scan, package-lambda]
    permissions:
      contents: read
      pull-requests: write  # For commenting on PRs if needed

    strategy:
      matrix:
        # Plan for both environments if workflow_dispatch, otherwise just staging
        environment: ${{ github.event_name == 'workflow_dispatch' && fromJSON('["staging", "prod"]') || fromJSON('["staging"]') }}

    outputs:
      plan-staging: ${{ steps.plan.outputs.plan-staging }}
      plan-prod: ${{ steps.plan.outputs.plan-prod }}

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1

      - name: Download Lambda artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: lambda-package-${{ needs.package-lambda.outputs.lambda-version }}
          path: ./

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3.1.2
        with:
          terraform_version: ~1.9.0
          terraform_wrapper: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502  # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ matrix.environment }}/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="encrypt=true"

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: terraform
        env:
          TF_VAR_lambda_zip_path: ../${{ needs.package-lambda.outputs.lambda-artifact-name }}
        run: |
          # Run plan and save output
          terraform plan \
            -var-file="${{ matrix.environment }}.tfvars" \
            -out="${{ matrix.environment }}.tfplan" \
            -input=false \
            -no-color | tee plan-output.txt

          # Create a summary
          echo "### Terraform Plan Summary - ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 50 plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload plan artifact
        uses: actions/upload-artifact@84480863f228bb9747b473957fcc9e309aa96097  # v4.4.2
        with:
          name: tfplan-${{ matrix.environment }}-${{ needs.package-lambda.outputs.lambda-version }}
          path: |
            terraform/${{ matrix.environment }}.tfplan
            terraform/plan-output.txt
          retention-days: 30
          if-no-files-found: error

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [package-lambda, terraform-plan]
    # Run on push to main OR manual dispatch with staging selected
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')

    environment:
      name: staging
      url: ${{ steps.output.outputs.api-url }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1

      - name: Download Lambda artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: lambda-package-${{ needs.package-lambda.outputs.lambda-version }}
          path: ./

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3.1.2
        with:
          terraform_version: ~1.9.0
          terraform_wrapper: false  # Disable wrapper for cleaner outputs

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502  # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=staging/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="encrypt=true"

      - name: Terraform Apply
        working-directory: terraform
        env:
          TF_VAR_lambda_zip_path: ../${{ needs.package-lambda.outputs.lambda-artifact-name }}
        run: |
          terraform apply \
            -var-file="staging.tfvars" \
            -auto-approve \
            -input=false

      - name: Capture outputs
        id: output
        working-directory: terraform
        run: |
          API_URL=$(terraform output -raw api_url || echo "N/A")
          API_KEY=$(terraform output -raw api_key_value || echo "N/A")

          echo "api-url=${API_URL}" >> $GITHUB_OUTPUT
          echo "::add-mask::${API_KEY}"

          echo "### Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: ${API_URL}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lambda Version**: ${{ needs.package-lambda.outputs.lambda-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [package-lambda, terraform-plan]
    # Only run on manual dispatch with prod selected
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'

    # Production environment with protection rules (requires manual approval)
    environment:
      name: production
      url: ${{ steps.output.outputs.api-url }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871  # v4.2.1

      - name: Download Lambda artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
        with:
          name: lambda-package-${{ needs.package-lambda.outputs.lambda-version }}
          path: ./

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3.1.2
        with:
          terraform_version: ~1.9.0
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502  # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="encrypt=true"

      - name: Terraform Apply
        working-directory: terraform
        env:
          TF_VAR_lambda_zip_path: ../${{ needs.package-lambda.outputs.lambda-artifact-name }}
        run: |
          terraform apply \
            -var-file="prod.tfvars" \
            -auto-approve \
            -input=false

      - name: Capture outputs
        id: output
        working-directory: terraform
        run: |
          API_URL=$(terraform output -raw api_url || echo "N/A")
          API_KEY=$(terraform output -raw api_key_value || echo "N/A")

          echo "api-url=${API_URL}" >> $GITHUB_OUTPUT
          echo "::add-mask::${API_KEY}"

          echo "### Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: ${API_URL}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lambda Version**: ${{ needs.package-lambda.outputs.lambda-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
